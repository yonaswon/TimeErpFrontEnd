"use client";

import React, { useState, useEffect } from "react";
import api from "@/api";
import {
  Package,
  Filter,
  ChevronDown,
  Calendar,
  CheckCircle,
  XCircle,
  ExternalLink,
  Warehouse,
  RefreshCw,
  PlusCircle,
} from "lucide-react";

interface Release {
  id: number;
  material: {
    id: number;
    name: string;
    type: string;
    code_name: string;
    available: string;
    parsialy_available: string;
    min_threshold: number;
    width: string | null;
    height: string | null;
    date: string;
    stats: any;
  };
  reason:
    | "ORDER"
    | "ADD"
    | "MAINTENANCE"
    | "SALES"
    | "TRANSFER"
    | "WASTE"
    | "DAMAGED";
  amount: string;
  proof_image: string | null;
  confirmed: boolean;
  date: string;
  order: number;
  maintenance: number | null;
  inventory: number;
  released_by: number;
  each_areal_material: any[];
}

interface ReleasesResponse {
  count: number;
  next: string | null;
  previous: string | null;
  results: Release[];
}

const ReleaseContent = ({ id }: { id: number }) => {
  const [releases, setReleases] = useState<Release[]>([]);
  const [loading, setLoading] = useState(true);
  const [loadingMore, setLoadingMore] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [nextUrl, setNextUrl] = useState<string | null>(null);
  const [hasMore, setHasMore] = useState(true);

  // Filter states
  const [reasonFilter, setReasonFilter] = useState<string>("ALL"); // ALL, ORDER, ADD
  const [inventoryFilter, setInventoryFilter] = useState<string>("ALL");
  const [showFilters, setShowFilters] = useState(false);
  const [availableInventories, setAvailableInventories] = useState<number[]>(
    []
  );

  const fetchReleases = async (url?: string, append: boolean = false) => {
    try {
      if (url) {
        setLoadingMore(true);
      } else {
        setLoading(true);
      }
      setError(null);

      const endpoint = url || `/api/release/?order=${id}`;
      const response = await api.get<ReleasesResponse>(endpoint);

      if (append) {
        // Append to existing releases for load more
        setReleases((prev) => [...prev, ...response.data.results]);
      } else {
        // Initial load
        setReleases(response.data.results);
        // Extract unique inventory IDs for filter
        const inventories = [
          ...new Set(response.data.results.map((r) => r.inventory)),
        ];
        setAvailableInventories(inventories);
      }

      setNextUrl(response.data.next);
      setHasMore(!!response.data.next);
    } catch (err: any) {
      setError(err.response?.data?.message || "Failed to fetch releases");
      console.error("Error fetching releases:", err);
    } finally {
      setLoading(false);
      setLoadingMore(false);
    }
  };

  useEffect(() => {
    fetchReleases();
  }, [id]);

  const handleLoadMore = () => {
    if (nextUrl && !loadingMore) {
      fetchReleases(nextUrl, true);
    }
  };

  const handleFilterChange = () => {
    // Filter logic will be applied client-side
    setShowFilters(false);
  };

  const handleResetFilters = () => {
    setReasonFilter("ALL");
    setInventoryFilter("ALL");
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  const getReasonColor = (reason: string) => {
    switch (reason) {
      case "ORDER":
        return "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400";
      case "ADD":
        return "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400";
      case "MAINTENANCE":
        return "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400";
      case "SALES":
        return "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400";
      default:
        return "bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400";
    }
  };

  const getReasonLabel = (reason: string) => {
    switch (reason) {
      case "ORDER":
        return "Order";
      case "ADD":
        return "Additional";
      case "MAINTENANCE":
        return "Maintenance";
      case "SALES":
        return "Sales";
      default:
        return reason;
    }
  };

  // Filter releases based on selected filters
  const filteredReleases = releases.filter((release) => {
    if (reasonFilter !== "ALL" && release.reason !== reasonFilter) {
      return false;
    }
    if (
      inventoryFilter !== "ALL" &&
      release.inventory.toString() !== inventoryFilter
    ) {
      return false;
    }
    return true;
  });

  const formatAmount = (amount: string, type: string) => {
    return `${amount} ${type === "A" ? "m²" : "m"}`;
  };

  // Loading state
  if (loading && releases.length === 0) {
    return (
      <div className="space-y-3">
        {[1, 2, 3].map((i) => (
          <div
            key={i}
            className="bg-white dark:bg-zinc-800 rounded-xl p-4 animate-pulse"
          >
            <div className="h-5 bg-gray-200 dark:bg-zinc-700 rounded mb-3 w-1/2"></div>
            <div className="h-4 bg-gray-200 dark:bg-zinc-700 rounded mb-2 w-2/3"></div>
            <div className="h-8 bg-gray-200 dark:bg-zinc-700 rounded"></div>
          </div>
        ))}
      </div>
    );
  }

  // Error state
  if (error && releases.length === 0) {
    return (
      <div className="text-center py-8 px-4">
        <div className="inline-flex items-center justify-center w-14 h-14 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
          <Package className="w-6 h-6 text-red-600 dark:text-red-400" />
        </div>
        <h3 className="text-base font-semibold text-gray-900 dark:text-white mb-2">
          Error Loading Releases
        </h3>
        <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">{error}</p>
        <button
          onClick={() => fetchReleases()}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
        >
          Try Again
        </button>
      </div>
    );
  }

  // Empty state
  if (releases.length === 0) {
    return (
      <div className="text-center py-8 px-4">
        <Package
          size={40}
          className="mx-auto text-gray-400 dark:text-gray-600 mb-3"
        />
        <h3 className="text-base font-semibold text-gray-900 dark:text-white mb-1">
          No Releases Found
        </h3>
        <p className="text-sm text-gray-500 dark:text-gray-400">
          No releases have been recorded for this order yet.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="bg-linear-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-900/10 rounded-xl p-4 border border-blue-200 dark:border-blue-800/50">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-lg font-bold text-blue-900 dark:text-blue-300">
              ORD-{id}
            </h2>
            <p className="text-sm text-blue-700 dark:text-blue-400">
              Order Releases: {releases.length} total releases
            </p>
          </div>
          <button
            onClick={() => setShowFilters(!showFilters)}
            className="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <Filter className="w-5 h-5" />
          </button>
        </div>
      </div>

      {/* Filters Panel */}
      {showFilters && (
        <div className="bg-white dark:bg-zinc-800 rounded-xl p-4 border border-gray-200 dark:border-zinc-700 space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="font-semibold text-gray-900 dark:text-white">
              Filters
            </h3>
            <button
              onClick={handleResetFilters}
              className="text-sm text-blue-600 dark:text-blue-400 hover:underline"
            >
              Reset All
            </button>
          </div>

          {/* Reason Filter */}
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Release Reason
            </label>
            <div className="flex gap-2">
              {["ALL", "ORDER", "ADD"].map((reason) => (
                <button
                  key={reason}
                  onClick={() => setReasonFilter(reason)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    reasonFilter === reason
                      ? reason === "ALL"
                        ? "bg-gray-800 text-white dark:bg-gray-700"
                        : getReasonColor(reason)
                      : "bg-gray-100 text-gray-700 dark:bg-zinc-700 dark:text-gray-300"
                  }`}
                >
                  {reason === "ALL" ? "All" : getReasonLabel(reason)}
                </button>
              ))}
            </div>
          </div>

          {/* Inventory Filter */}
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Inventory
            </label>
            <div className="relative">
              <select
                value={inventoryFilter}
                onChange={(e) => setInventoryFilter(e.target.value)}
                className="w-full px-3 py-2 bg-gray-50 dark:bg-zinc-700 border border-gray-200 dark:border-zinc-600 rounded-lg text-gray-900 dark:text-white text-sm"
              >
                <option value="ALL">All Inventories</option>
                {availableInventories.map((invId) => (
                  <option key={invId} value={invId.toString()}>
                    Inventory #{invId}
                  </option>
                ))}
              </select>
              <ChevronDown className="absolute right-3 top-2.5 w-4 h-4 text-gray-400 pointer-events-none" />
            </div>
          </div>

          <button
            onClick={handleFilterChange}
            className="w-full py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
          >
            Apply Filters
          </button>
        </div>
      )}

      {/* Filter Summary */}
      {(reasonFilter !== "ALL" || inventoryFilter !== "ALL") && (
        <div className="flex items-center justify-between text-sm">
          <div className="text-gray-600 dark:text-gray-400">
            Showing {filteredReleases.length} of {releases.length} releases
          </div>
          <button
            onClick={handleResetFilters}
            className="text-blue-600 dark:text-blue-400 hover:underline"
          >
            Clear filters
          </button>
        </div>
      )}

      {/* Releases List */}
      <div className="space-y-3">
        {filteredReleases.map((release) => (
          <div
            key={release.id}
            className="bg-white dark:bg-zinc-800 rounded-xl p-4 border border-gray-200 dark:border-zinc-700 hover:border-blue-300 dark:hover:border-blue-700 transition-colors"
          >
            <div className="flex justify-between items-start mb-3">
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                  <Package className="w-4 h-4 text-gray-400" />
                  <h3 className="font-semibold text-gray-900 dark:text-white truncate">
                    {release.material.name}
                  </h3>
                </div>
                <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                  <span>{release.material.code_name}</span>
                  <span>•</span>
                  <span>{formatDate(release.date)}</span>
                </div>
              </div>

              <div className="flex flex-col items-end gap-1">
                <span
                  className={`px-2 py-1 rounded-full text-xs font-medium ${getReasonColor(
                    release.reason
                  )}`}
                >
                  {getReasonLabel(release.reason)}
                </span>
                <div className="flex items-center gap-1">
                  {release.confirmed ? (
                    <CheckCircle className="w-3 h-3 text-green-500" />
                  ) : (
                    <XCircle className="w-3 h-3 text-yellow-500" />
                  )}
                  <span className="text-xs text-gray-500 dark:text-gray-400">
                    {release.confirmed ? "Confirmed" : "Pending"}
                  </span>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4 mb-3">
              <div>
                <div className="text-xs text-gray-500 dark:text-gray-400 mb-1">
                  Amount
                </div>
                <div className="text-lg font-bold text-gray-900 dark:text-white">
                  {formatAmount(release.amount, release.material.type)}
                </div>
              </div>

              <div>
                <div className="text-xs text-gray-500 dark:text-gray-400 mb-1">
                  Inventory
                </div>
                <div className="flex items-center gap-1">
                  <Warehouse className="w-3 h-3 text-gray-400" />
                  <span className="font-medium text-gray-900 dark:text-white">
                    #{release.inventory}
                  </span>
                </div>
              </div>
            </div>

            {/* Additional Info */}
            <div className="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-zinc-700">
              <div className="text-xs text-gray-500 dark:text-gray-400">
                Release #{release.id}
              </div>
              {release.proof_image && (
                <div className="text-xs text-green-600 dark:text-green-400">
                  Proof available
                </div>
              )}
            </div>
          </div>
        ))}
      </div>

      {/* Load More Button */}
      {hasMore && filteredReleases.length > 0 && (
        <div className="pt-4">
          <button
            onClick={handleLoadMore}
            disabled={loadingMore}
            className="w-full px-4 py-3 rounded-xl bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 hover:bg-gray-50 dark:hover:bg-zinc-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
          >
            {loadingMore ? (
              <>
                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                <span className="text-sm font-medium">Loading more...</span>
              </>
            ) : (
              <>
                <PlusCircle className="w-5 h-5" />
                <span className="text-sm font-medium">Load More Releases</span>
              </>
            )}
          </button>
        </div>
      )}

      {/* No results after filtering */}
      {filteredReleases.length === 0 && releases.length > 0 && (
        <div className="text-center py-8 px-4">
          <Filter
            size={40}
            className="mx-auto text-gray-400 dark:text-gray-600 mb-3"
          />
          <h3 className="text-base font-semibold text-gray-900 dark:text-white mb-1">
            No matching releases
          </h3>
          <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
            Try changing your filter settings
          </p>
          <button
            onClick={handleResetFilters}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Reset Filters
          </button>
        </div>
      )}

      {/* Stats Footer */}
      <div className="text-center text-xs text-gray-500 dark:text-gray-400 pt-4 border-t border-gray-200 dark:border-zinc-700">
        Showing {filteredReleases.length} releases • Order #{id}
      </div>
    </div>
  );
};

export default ReleaseContent;
 This is working every thing as it is bu ti need to add the edit functionality and display the edited amount 

 
class ReleaseModelViewSet(viewsets.ModelViewSet):
    queryset = Release.objects.all()
    serializer_class = ReleaseViewDetailSerializer
    pagination_class = ReleasePagination
    filter_backends = [DjangoFilterBackend, OrderingFilter]
    filterset_fields = ['reason', 'maintenance', "order"]

    @action(detail  = True, methods = ['post'])
    def edit_release(self,request,pk=None):
        try:
            new_amount = request.data.get('amount')
            if not new_amount:
                return Response({'error':"Amount is Requered"},status = status.HTTP_400_BAD_REQUEST)
            
            release = self.get_object()

            if not release:
                return Response({'error':"Release not found"},status = status.HTTP_400_BAD_REQUEST)
            
            release_amount  = release.amount
            difference = release_amount - Decimal(str(new_amount))
            if difference <= 0:
                return Response({'error':"Amount must be greater than zero"},status = status.HTTP_400_BAD_REQUEST)
            
            with transaction.atomic:
                landprecord = LandPMaterialRecord.objects.create(
                    material = release.material,
                    inventory = release.inventory,
                    first_amount = difference,
                    current_amount = difference,
                    is_active = True,
                    created_by = request.user
                )
                release.amount = Decimal(str(new_amount))
                release.is_edited = True
                release.l_and_p_material_records_for_eidt.add(landprecord)
                release.save()

                return Response({'status':"success","message":"Release updated successfully"},status = status.HTTP_200_OK)
        except Exception as e:
            return Response({'error':str(e)},status = status.HTTP_400_BAD_REQUEST)
 this is my model view set and the endpoint is api/release/{relase id }/edit_release

 and i also update the model to get the is_edited .. and landp l_and_p_material_records_for_eidt fields 

 on the display of releases show if the mateiral is edited or not and .. i want you to create another file for edit called ReleaseEditOveraly and on the overaly enter amount if the amount entered is grater than the current amount disable the edit button and say you can't edit to the grater ask for addtional release .. if its the saem can't do that .. if the amount entred is less thean the current amount then send the post request .. the the action method .. 

 i need the current appdeted file and another overaly file only 

 handle dark and hwite mode mobile first design .. use api for api requests ...  